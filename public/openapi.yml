openapi: 3.0.3
info:
  title: Q Medis API
  version: 1.0.0
  description: Static OpenAPI spec
servers:
  - url: http://localhost:8000
paths:
  /api:
    get:
      tags: [System]
      summary: API health (welcome)
      responses:
        '200':
          description: OK
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        '200': { description: OK }
        '401': { description: Invalid credentials }
  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token using refresh token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token: { type: string }
      responses:
        '200': { description: OK }
        '401': { description: Invalid refresh token }
  /api/auth/me:
    get:
      tags: [Auth]
      summary: Get authenticated user
      security:
        - bearerAuth: []
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Logout and revoke refresh token
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refresh_token]
              properties:
                refresh_token: { type: string }
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
  /api/dashboard:
    get:
      tags: [Dashboard]
      summary: Get dashboard data (role-based)
      description: Returns different dashboard data based on user role (admin or petugas)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/AdminDashboard'
                      - $ref: '#/components/schemas/PetugasDashboard'
        '401': { description: Unauthorized }
        '403': { description: Unauthorized role }
  /api/display/lokets:
    get:
      tags: [Display]
      summary: List lokets (public)
      responses:
        '200': { description: OK }
  /api/display/lokets/{loket}:
    get:
      tags: [Display]
      summary: Get display data for a loket (public)
      parameters:
        - in: path
          name: loket
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }
        '404': { description: Not found }
  /api/display/overview:
    get:
      tags: [Display]
      summary: Display overview for all lokets (public)
      responses:
        '200': { description: OK }
  /api/display/antrians:
    post:
      tags: [Display]
      summary: Create an antrian (public)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AntrianCreateRequest'
      responses:
        '201': { description: Created }
        '422': { description: Validation error }
  /api/lokets:
    get:
      tags: [Lokets]
      summary: List lokets (paginated)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: per_page
          schema: { type: integer, default: 15 }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: order_by
          schema:
            type: string
            enum: [id, nama_loket, kode_prefix, created_at, updated_at]
        - in: query
          name: order_dir
          schema:
            type: string
            enum: [asc, desc]
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
    post:
      tags: [Lokets]
      summary: Create a loket
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoketCreateRequest'
      responses:
        '201': { description: Created }
        '401': { description: Unauthorized }
  /api/lokets/{loket}:
    get:
      tags: [Lokets]
      summary: Get a loket by ID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: loket
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
        '404': { description: Not found }
  /api/users:
    get:
      tags: [Users]
      summary: List users (paginated)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: per_page
          schema: { type: integer, default: 15 }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: order_by
          schema:
            type: string
            enum: [id, name, email, role, created_at, updated_at]
        - in: query
          name: order_dir
          schema:
            type: string
            enum: [asc, desc]
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
    post:
      tags: [Users]
      summary: Create user
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest'
      responses:
        '201': { description: Created }
        '401': { description: Unauthorized }
  /api/users/{user}:
    get:
      tags: [Users]
      summary: Get user by ID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: user
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
        '404': { description: Not found }
    put:
      tags: [Users]
      summary: Update user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: user
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
        '404': { description: Not found }
    delete:
      tags: [Users]
      summary: Delete user
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: user
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
        '404': { description: Not found }
  /api/antrians:
    get:
      tags: [Antrians]
      summary: List antrians (paginated)
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: per_page
          schema: { type: integer, default: 15 }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: order_by
          schema:
            type: string
            enum: [id, loket_id, nomor_antrian, status, waktu_panggil, created_at, updated_at]
        - in: query
          name: order_dir
          schema:
            type: string
            enum: [asc, desc]
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
    post:
      tags: [Antrians]
      summary: Create an antrian
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AntrianCreateRequest'
      responses:
        '201': { description: Created }
        '401': { description: Unauthorized }
  /api/antrians/{antrian}:
    get:
      tags: [Antrians]
      summary: Get an antrian by ID
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: antrian
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
        '404': { description: Not found }
    put:
      tags: [Antrians]
      summary: Update an antrian status
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: antrian
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AntrianUpdateRequest'
      responses:
        '200': { description: OK }
        '401': { description: Unauthorized }
        '404': { description: Not found }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    LoketCreateRequest:
      type: object
      required: [nama_loket, kode_prefix]
      properties:
        nama_loket: { type: string, maxLength: 100 }
        kode_prefix: { type: string, maxLength: 5 }
        deskripsi: { type: string, nullable: true }
    LoketUpdateRequest:
      type: object
      properties:
        nama_loket: { type: string, maxLength: 100 }
        kode_prefix: { type: string, maxLength: 5 }
        deskripsi: { type: string, nullable: true }
    AntrianCreateRequest:
      type: object
      required: [loket_id]
      properties:
        loket_id: { type: integer }
    AntrianUpdateRequest:
      type: object
      required: [status]
      properties:
        status: { type: string, example: dipanggil }
    UserCreateRequest:
      type: object
      required: [name, email, password]
      properties:
        name: { type: string, maxLength: 255 }
        email: { type: string, format: email, maxLength: 255 }
        password: { type: string, minLength: 6 }
        role: { type: string, nullable: true, maxLength: 50 }
        avatar: { type: string, nullable: true, maxLength: 2048 }
        google_id: { type: string, nullable: true, maxLength: 255 }
    UserUpdateRequest:
      type: object
      properties:
        name: { type: string, maxLength: 255 }
        email: { type: string, format: email, maxLength: 255 }
        password: { type: string, minLength: 6 }
        role: { type: string, nullable: true, maxLength: 50 }
        avatar: { type: string, nullable: true, maxLength: 2048 }
        google_id: { type: string, nullable: true, maxLength: 255 }
    AdminDashboard:
      type: object
      properties:
        statistics:
          type: object
          properties:
            total_lokets: { type: integer }
            total_users: { type: integer }
            total_petugas: { type: integer }
            total_antrians_today: { type: integer }
        antrian_by_status:
          type: object
          properties:
            menunggu: { type: integer }
            dipanggil: { type: integer }
            selesai: { type: integer }
        loket_statistics:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              nama_loket: { type: string }
              kode_prefix: { type: string }
              total_today: { type: integer }
              menunggu: { type: integer }
              dipanggil: { type: integer }
              selesai: { type: integer }
        recent_antrians:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              loket_id: { type: integer }
              nomor_antrian: { type: string }
              status: { type: string, enum: [menunggu, dipanggil, selesai] }
              waktu_panggil: { type: string, format: date-time, nullable: true }
              created_at: { type: string, format: date-time }
              updated_at: { type: string, format: date-time }
              loket:
                type: object
                properties:
                  id: { type: integer }
                  nama_loket: { type: string }
                  kode_prefix: { type: string }
                  deskripsi: { type: string, nullable: true }
        hourly_statistics:
          type: array
          items:
            type: object
            properties:
              hour: { type: integer, description: "Hour of the day (0-23)" }
              total: { type: integer, description: "Total antrians in that hour" }
      example:
        statistics:
          total_lokets: 5
          total_users: 12
          total_petugas: 8
          total_antrians_today: 45
        antrian_by_status:
          menunggu: 12
          dipanggil: 3
          selesai: 30
        loket_statistics:
          - id: 1
            nama_loket: "Loket A"
            kode_prefix: "A"
            total_today: 15
            menunggu: 5
            dipanggil: 1
            selesai: 9
        recent_antrians:
          - id: 45
            loket_id: 1
            nomor_antrian: "A015"
            status: "menunggu"
            waktu_panggil: null
            created_at: "2024-11-01T14:30:00Z"
            updated_at: "2024-11-01T14:30:00Z"
            loket:
              id: 1
              nama_loket: "Loket A"
              kode_prefix: "A"
              deskripsi: "Pendaftaran"
        hourly_statistics:
          - hour: 8
            total: 5
          - hour: 9
            total: 12
          - hour: 10
            total: 15
    PetugasDashboard:
      type: object
      properties:
        statistics:
          type: object
          properties:
            total_antrians_today: { type: integer }
            menunggu: { type: integer }
            dipanggil: { type: integer }
            selesai: { type: integer }
        current_queue:
          type: object
          nullable: true
          properties:
            id: { type: integer }
            loket_id: { type: integer }
            nomor_antrian: { type: string }
            status: { type: string }
            waktu_panggil: { type: string, format: date-time }
            created_at: { type: string, format: date-time }
            loket:
              type: object
              properties:
                id: { type: integer }
                nama_loket: { type: string }
                kode_prefix: { type: string }
        next_queue:
          type: object
          nullable: true
          properties:
            id: { type: integer }
            loket_id: { type: integer }
            nomor_antrian: { type: string }
            status: { type: string }
            created_at: { type: string, format: date-time }
            loket:
              type: object
              properties:
                id: { type: integer }
                nama_loket: { type: string }
                kode_prefix: { type: string }
        recent_antrians:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              loket_id: { type: integer }
              nomor_antrian: { type: string }
              status: { type: string, enum: [menunggu, dipanggil, selesai] }
              waktu_panggil: { type: string, format: date-time, nullable: true }
              created_at: { type: string, format: date-time }
              loket:
                type: object
                properties:
                  id: { type: integer }
                  nama_loket: { type: string }
                  kode_prefix: { type: string }
        loket_statistics:
          type: array
          items:
            type: object
            properties:
              id: { type: integer }
              nama_loket: { type: string }
              kode_prefix: { type: string }
              total_today: { type: integer }
              menunggu: { type: integer }
              dipanggil: { type: integer }
              selesai: { type: integer }
      example:
        statistics:
          total_antrians_today: 15
          menunggu: 5
          dipanggil: 1
          selesai: 9
        current_queue:
          id: 12
          loket_id: 1
          nomor_antrian: "A012"
          status: "dipanggil"
          waktu_panggil: "2024-11-01T14:20:00Z"
          created_at: "2024-11-01T14:15:00Z"
          loket:
            id: 1
            nama_loket: "Loket A"
            kode_prefix: "A"
        next_queue:
          id: 13
          loket_id: 1
          nomor_antrian: "A013"
          status: "menunggu"
          created_at: "2024-11-01T14:18:00Z"
          loket:
            id: 1
            nama_loket: "Loket A"
            kode_prefix: "A"
        recent_antrians:
          - id: 15
            loket_id: 1
            nomor_antrian: "A015"
            status: "menunggu"
            waktu_panggil: null
            created_at: "2024-11-01T14:30:00Z"
            loket:
              id: 1
              nama_loket: "Loket A"
              kode_prefix: "A"
        loket_statistics:
          - id: 1
            nama_loket: "Loket A"
            kode_prefix: "A"
            total_today: 15
            menunggu: 5
            dipanggil: 1
            selesai: 9
